<template></template>

<script>
import template from "./template";
import { mapState, mapActions } from "vuex";

import {
  remote,
  ipcRenderer,
  Menu,
  dialog,
  fs,
  jetpack,
  currentWindow
} from "../../../common";

import EditorInstance from "../Panes/Editor/EditorInstance";

export default {
  methods: {
    closeWindow(event) {
      console.log(event);
      const choice = dialog.showMessageBoxSync({
        type: "question",
        buttons: ["Yes", "No"],
        title: "Confirm",
        message: "Are you sure you want to quit?"
      });
      console.log("Choice", choice);

      event.preventDefault();
    },
    openFile() {
      // if some contents are there in a new window, prompt user to save

      // if a file is already open and unsaved, prompt user to save

      // open dialog for .crncl file selection
      const file_paths = dialog.showOpenDialogSync({
        properties: ["openDirectory", "treatPackageAsDirectory"],
        filters: [{ name: "Chronicle Files", extensions: [".crncl"] }]
      });

      if (!file_paths) {
        return;
      }

      const file_path = file_paths[0];
      this.m_current_file_set({ file_path });
      currentWindow.setTitle("Intrepid - " + file_path);

      // check for a JSON file inside
      const content = jetpack.read(file_path + "/content.json");
      EditorInstance.setContent(JSON.parse(content));
    },
    saveFile() {
      let file_path = this.s_current_file_path;

      // if path doesn't exist, ask where to save it
      if (!file_path) {
        file_path = dialog.showSaveDialogSync({
          showsTagField: true,
          defaultPath: "Untitled.crncl"
        });

        if (!file_path) {
          return;
        }
      }

      this.m_current_file_set({ file_path });
      currentWindow.setTitle("Intrepid - " + file_path);

      // e.g. file_path === .../.../Untitled.crncl

      // flush contents to current path
      const content = EditorInstance.getJSON();
      const json = JSON.stringify(content);
      try {
        jetpack.dir(file_path);
        fs.writeFileSync(file_path + "/content.json", json, "utf-8");
      } catch (e) {
        console.log(e);
      }

      currentWindow.setDocumentEdited(false);
    },
    ...mapActions("Document", ["m_current_file_set"])
  },
  computed: {
    ...mapState("Document", ["s_current_file_path"])
  },
  created() {
    // create menu
    const menu = Menu.buildFromTemplate(template);
    Menu.setApplicationMenu(menu);

    // register listeners
    ipcRenderer.on("file-open", (event, data) => {
      this.openFile();
    });

    ipcRenderer.on("file-save", (event, data) => {
      this.saveFile();
    });

    ipcRenderer.on("window-close", (event, data) => {
      this.closeWindow(data);
    });
  }
};
</script>

<style>
</style>